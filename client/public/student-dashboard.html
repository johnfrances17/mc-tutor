<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - MC Tutor</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="nav-brand">MC Tutor</a>
            <div class="nav-links">
                <a href="student-dashboard.html" class="nav-link active">Dashboard</a>
                <a href="find-tutors.html" class="nav-link">Find Tutors</a>
                <a href="my-sessions.html" class="nav-link">My Sessions</a>
                <a href="materials.html" class="nav-link">Materials</a>
                <a href="messenger.html" class="nav-link">
                    Messages
                    <span class="badge" id="unreadMessagesCount" style="display: none;"></span>
                </a>
                <a href="profile.html" class="nav-link">Profile</a>
                <a href="#" class="nav-link" id="logoutBtn">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <div>
                <h1>Welcome, <span id="studentName">Student</span>!</h1>
                <p class="text-muted">Here's your learning overview</p>
            </div>
            <a href="find-tutors.html" class="btn btn-primary">
                <span>üìö</span> Find Tutors
            </a>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-content">
                    <div class="stat-value" id="upcomingSessionsCount">0</div>
                    <div class="stat-label">Upcoming Sessions</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-content">
                    <div class="stat-value" id="completedSessionsCount">0</div>
                    <div class="stat-label">Completed Sessions</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí¨</div>
                <div class="stat-content">
                    <div class="stat-value" id="unreadChatsCount">0</div>
                    <div class="stat-label">Unread Messages</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÑ</div>
                <div class="stat-content">
                    <div class="stat-value" id="materialsCount">0</div>
                    <div class="stat-label">Study Materials</div>
                </div>
            </div>
        </div>

        <!-- Notifications -->
        <div class="card" id="notificationsSection" style="display: none;">
            <div class="card-header">
                <h3>Recent Notifications</h3>
                <a href="#" id="markAllReadBtn" class="text-primary">Mark all as read</a>
            </div>
            <div class="card-body" id="notificationsList">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- Upcoming Sessions -->
        <div class="card">
            <div class="card-header">
                <h3>Upcoming Sessions</h3>
                <a href="my-sessions.html" class="text-primary">View all</a>
            </div>
            <div class="card-body" id="upcomingSessionsList">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- Pending Sessions -->
        <div class="card" id="pendingSessionsCard" style="display: none;">
            <div class="card-header">
                <h3>Pending Sessions</h3>
                <span class="badge badge-warning" id="pendingCount">0</span>
            </div>
            <div class="card-body" id="pendingSessionsList"></div>
        </div>

        <!-- Recent Materials -->
        <div class="card">
            <div class="card-header">
                <h3>Recent Study Materials</h3>
                <a href="materials.html" class="text-primary">View all</a>
            </div>
            <div class="card-body" id="recentMaterialsList">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <script type="module" src="js/api.js"></script>
    <script type="module" src="js/auth.js"></script>
    <script type="module" src="js/utils.js"></script>
    <script type="module">
        import { api } from './js/api.js';
        import { logout, getCurrentUser } from './js/auth.js';
        import { showToast, formatDate, formatTime, formatDateTime, getStatusBadgeClass } from './js/utils.js';

        let currentUser = null;

        // Initialize dashboard
        async function initDashboard() {
            try {
                currentUser = await getCurrentUser();
                
                if (!currentUser) {
                    window.location.href = 'login.html';
                    return;
                }

                if (currentUser.role !== 'tutee') {
                    showToast('Access denied. Students only.', 'error');
                    setTimeout(() => window.location.href = 'index.html', 2000);
                    return;
                }

                document.getElementById('studentName').textContent = currentUser.full_name;

                // Load all data in parallel
                await Promise.all([
                    loadStats(),
                    loadNotifications(),
                    loadUpcomingSessions(),
                    loadRecentMaterials()
                ]);
            } catch (error) {
                console.error('Dashboard init error:', error);
                showToast('Failed to load dashboard', 'error');
            }
        }

        // Load dashboard statistics
        async function loadStats() {
            try {
                const [sessions, conversations, materials] = await Promise.all([
                    api.get('/sessions'),
                    api.get('/chat/conversations'),
                    api.get('/materials')
                ]);

                const upcoming = sessions.data.filter(s => 
                    s.status === 'confirmed' && new Date(s.session_date) > new Date()
                );
                const completed = sessions.data.filter(s => s.status === 'completed');
                const unreadChats = conversations.data.reduce((sum, conv) => sum + conv.unread_count, 0);

                document.getElementById('upcomingSessionsCount').textContent = upcoming.length;
                document.getElementById('completedSessionsCount').textContent = completed.length;
                document.getElementById('unreadChatsCount').textContent = unreadChats;
                document.getElementById('materialsCount').textContent = materials.data.length;

                // Update message badge
                const badge = document.getElementById('unreadMessagesCount');
                if (unreadChats > 0) {
                    badge.textContent = unreadChats;
                    badge.style.display = 'inline-block';
                }
            } catch (error) {
                console.error('Stats error:', error);
            }
        }

        // Load notifications
        async function loadNotifications() {
            try {
                const response = await api.get('/notifications?limit=5');
                const notifications = response.data;

                if (notifications.length === 0) {
                    return; // Hide section if no notifications
                }

                document.getElementById('notificationsSection').style.display = 'block';
                
                const container = document.getElementById('notificationsList');
                container.innerHTML = notifications.map(notif => `
                    <div class="notification-item ${notif.is_read ? 'read' : 'unread'}">
                        <div class="notification-icon">${getNotificationIcon(notif.type)}</div>
                        <div class="notification-content">
                            <div class="notification-title">${notif.title}</div>
                            <div class="notification-message">${notif.message}</div>
                            <div class="notification-time">${formatDateTime(notif.created_at)}</div>
                        </div>
                        ${!notif.is_read ? `
                            <button class="btn btn-sm" onclick="markAsRead('${notif.id}')">Mark read</button>
                        ` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Notifications error:', error);
                document.getElementById('notificationsList').innerHTML = 
                    '<p class="text-muted">Failed to load notifications</p>';
            }
        }

        // Load upcoming sessions
        async function loadUpcomingSessions() {
            try {
                const response = await api.get('/sessions?status=confirmed');
                const sessions = response.data;

                const upcoming = sessions
                    .filter(s => new Date(s.session_date) > new Date())
                    .sort((a, b) => new Date(a.session_date) - new Date(b.session_date))
                    .slice(0, 5);

                const pending = sessions.filter(s => s.status === 'pending');

                const container = document.getElementById('upcomingSessionsList');
                
                if (upcoming.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>No upcoming sessions scheduled</p>
                            <a href="find-tutors.html" class="btn btn-primary">Book a Session</a>
                        </div>
                    `;
                } else {
                    container.innerHTML = upcoming.map(session => `
                        <div class="session-item">
                            <div class="session-info">
                                <div class="session-subject">${session.subject_name || 'Subject'}</div>
                                <div class="session-details">
                                    <span>üë§ ${session.tutor_name}</span>
                                    <span>üìÖ ${formatDate(session.session_date)}</span>
                                    <span>üïê ${formatTime(session.session_time)}</span>
                                    <span>üìç ${session.session_type}</span>
                                </div>
                            </div>
                            <div class="session-actions">
                                <span class="badge ${getStatusBadgeClass(session.status)}">${session.status}</span>
                                <button class="btn btn-sm" onclick="viewSession('${session.id}')">View</button>
                            </div>
                        </div>
                    `).join('');
                }

                // Show pending sessions if any
                if (pending.length > 0) {
                    document.getElementById('pendingSessionsCard').style.display = 'block';
                    document.getElementById('pendingCount').textContent = pending.length;
                    document.getElementById('pendingSessionsList').innerHTML = pending.map(session => `
                        <div class="session-item">
                            <div class="session-info">
                                <div class="session-subject">${session.subject_name || 'Subject'}</div>
                                <div class="session-details">
                                    <span>üë§ ${session.tutor_name}</span>
                                    <span>üìÖ ${formatDate(session.session_date)}</span>
                                </div>
                            </div>
                            <span class="badge badge-warning">Pending Approval</span>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Sessions error:', error);
                document.getElementById('upcomingSessionsList').innerHTML = 
                    '<p class="text-muted">Failed to load sessions</p>';
            }
        }

        // Load recent materials
        async function loadRecentMaterials() {
            try {
                const response = await api.get('/materials?limit=5');
                const materials = response.data;

                const container = document.getElementById('recentMaterialsList');
                
                if (materials.length === 0) {
                    container.innerHTML = '<p class="text-muted">No study materials available yet</p>';
                } else {
                    container.innerHTML = materials.map(material => `
                        <div class="material-item">
                            <div class="material-icon">üìÑ</div>
                            <div class="material-info">
                                <div class="material-title">${material.title}</div>
                                <div class="material-meta">
                                    <span>${material.subject_name}</span>
                                    <span>‚Ä¢</span>
                                    <span>By ${material.tutor_name}</span>
                                    <span>‚Ä¢</span>
                                    <span>${formatDate(material.uploaded_at)}</span>
                                </div>
                            </div>
                            <button class="btn btn-sm" onclick="downloadMaterial('${material.id}', '${material.filename}')">
                                Download
                            </button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Materials error:', error);
                document.getElementById('recentMaterialsList').innerHTML = 
                    '<p class="text-muted">Failed to load materials</p>';
            }
        }

        // Helper: Get notification icon
        function getNotificationIcon(type) {
            const icons = {
                session_confirmed: '‚úÖ',
                session_cancelled: '‚ùå',
                session_completed: 'üéì',
                new_message: 'üí¨',
                feedback_received: '‚≠ê',
                material_uploaded: 'üìÑ',
                session_reminder: '‚è∞',
                general: 'üîî'
            };
            return icons[type] || icons.general;
        }

        // Mark notification as read
        window.markAsRead = async function(notificationId) {
            try {
                await api.put(`/notifications/${notificationId}/read`);
                await loadNotifications();
                showToast('Notification marked as read', 'success');
            } catch (error) {
                showToast('Failed to update notification', 'error');
            }
        };

        // Mark all notifications as read
        document.getElementById('markAllReadBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await api.put('/notifications/read-all');
                await loadNotifications();
                showToast('All notifications marked as read', 'success');
            } catch (error) {
                showToast('Failed to update notifications', 'error');
            }
        });

        // View session details
        window.viewSession = function(sessionId) {
            window.location.href = `session-details.html?id=${sessionId}`;
        };

        // Download material
        window.downloadMaterial = async function(materialId, filename) {
            try {
                await api.download(`/materials/${materialId}/download`, filename);
                showToast('Download started', 'success');
            } catch (error) {
                showToast('Download failed', 'error');
            }
        };

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            await logout();
        });

        // Initialize on load
        initDashboard();

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadStats();
            loadNotifications();
        }, 30000);
    </script>
</body>
</html>
