<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register - MC Tutor</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    body {
      background: #f5f5f5;
      padding: 40px 20px;
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <div class="auth-container" style="max-width: 600px;">
    <div class="auth-card">
      <div class="auth-header">
        <h1>MC Tutor</h1>
        <p>Join Our Tutoring Community</p>
        <p style="font-size: 13px; color: #999; margin-top: 5px;">Mabini College Inc.</p>
      </div>

      <form id="registerForm" class="auth-form">
        <h2>Register</h2>

        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div class="form-group">
          <label for="student_id">Student ID *</label>
          <input type="text" id="student_id" name="student_id" placeholder="e.g., 2021-12345" required>
        </div>

        <div class="form-group">
          <label for="full_name">Full Name *</label>
          <input type="text" id="full_name" name="full_name" placeholder="Juan Dela Cruz" required>
        </div>

        <div class="form-group">
          <label for="email">Email Address *</label>
          <input type="email" id="email" name="email" placeholder="student@example.com" required>
        </div>

        <div class="form-group">
          <label for="phone">Phone Number *</label>
          <input type="tel" id="phone" name="phone" placeholder="09123456789" required>
        </div>

        <div class="form-group">
          <label for="role">I want to be a *</label>
          <select id="role" name="role" required>
            <option value="">Select role</option>
            <option value="tutee">Student (Looking for tutoring)</option>
            <option value="tutor">Tutor (Provide tutoring)</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="year_level">Year Level *</label>
            <select id="year_level" name="year_level" required>
              <option value="">Select year level</option>
              <option value="1st Year">1st Year</option>
              <option value="2nd Year">2nd Year</option>
              <option value="3rd Year">3rd Year</option>
              <option value="4th Year">4th Year</option>
              <option value="N/A">N/A</option>
            </select>
          </div>

          <div class="form-group">
            <label for="course">Course *</label>
            <select id="course" name="course" required>
              <option value="">Select course</option>
              <optgroup label="Business & Administration">
                <option value="Administration">Administration</option>
                <option value="BS in Accountancy (B.S.A.)">BS in Accountancy (B.S.A.)</option>
                <option value="BS in Business Administration - Operations Management (B.S.B.A.)">BS in Business Administration - Operations Management</option>
                <option value="BS in Business Administration - Financial Management (B.S.B.A.)">BS in Business Administration - Financial Management</option>
                <option value="Bachelor of Science in Entrepreneurship (B.S. Entrep.)">BS in Entrepreneurship (B.S. Entrep.)</option>
              </optgroup>
              <optgroup label="Education">
                <option value="Bachelor in Secondary Education - English (B.S.Ed.)">Bachelor in Secondary Education - English</option>
                <option value="Bachelor in Secondary Education - Mathematics (B.S.Ed.)">Bachelor in Secondary Education - Mathematics</option>
                <option value="Bachelor in Secondary Education - Filipino (B.S.Ed.)">Bachelor in Secondary Education - Filipino</option>
                <option value="Bachelor in Secondary Education - MAPEH (B.S.Ed.)">Bachelor in Secondary Education - MAPEH</option>
                <option value="Bachelor in Secondary Education - Social Studies (B.S.Ed.)">Bachelor in Secondary Education - Social Studies</option>
                <option value="Bachelor in Elementary Education - Content Course (B.E.Ed.)">Bachelor in Elementary Education - Content Course</option>
                <option value="Bachelor in Elementary Education - Special Education (B.E.Ed.)">Bachelor in Elementary Education - Special Education</option>
                <option value="Bachelor in Elementary Education - Pre-School Education (B.E.Ed.)">Bachelor in Elementary Education - Pre-School Education</option>
                <option value="Bachelor of Early Childhood Education (B.E.C.Ed)">Bachelor of Early Childhood Education</option>
                <option value="Bachelor of Special Needs Education (B.S.N.Ed)">Bachelor of Special Needs Education</option>
                <option value="Bachelor of Culture and Arts Education (B.C.A.Ed)">Bachelor of Culture and Arts Education</option>
                <option value="Bachelor of Physical Education (B.P.Ed.)">Bachelor of Physical Education</option>
              </optgroup>
              <optgroup label="Computer Science & IT">
                <option value="Bachelor of Science in Computer Science (B.S.C.S.)">BS in Computer Science (B.S.C.S.)</option>
              </optgroup>
              <optgroup label="Health Sciences">
                <option value="Bachelor of Science in Nursing (B.S.N.)">BS in Nursing (B.S.N.)</option>
              </optgroup>
              <optgroup label="Law & Criminology">
                <option value="Bachelor of Science in Criminology (B.S. Crim.)">BS in Criminology (B.S. Crim.)</option>
              </optgroup>
              <optgroup label="Arts & Communication">
                <option value="Bachelor of Arts in Communication (B.A. Comm)">Bachelor of Arts in Communication</option>
              </optgroup>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="password">Password *</label>
          <input type="password" id="password" name="password" minlength="6" placeholder="At least 6 characters" required>
          <small style="color: #666;">At least 6 characters</small>
        </div>

        <div class="form-group">
          <label for="confirm_password">Confirm Password *</label>
          <input type="password" id="confirm_password" name="confirm_password" placeholder="Re-enter your password" required>
        </div>

        <button type="submit" class="btn btn-primary" id="registerBtn" style="width: 100%;">
          Register
        </button>

        <div class="auth-footer">
          <p>Already have an account? <a href="/html/login.html">Login here</a></p>
        </div>
      </form>
    </div>
  </div>

  <script type="module" src="../scripts/api.js"></script>
  <script type="module" src="../scripts/auth.js"></script>
  <script type="module" src="../scripts/utils.js"></script>
  <script type="module">
    import { api } from '../scripts/api.js';
    import { getCurrentUser } from '../scripts/auth.js';

    // Redirect if already logged in
    try {
      const user = await getCurrentUser();
      if (user) {
        const dashboards = {
          'admin': 'admin-dashboard.html',
          'tutor': 'tutor-dashboard.html',
          'tutee': 'student-dashboard.html'
        };
        window.location.href = dashboards[user.role] || 'student-dashboard.html';
      }
    } catch (error) {
      // User not logged in, continue
    }

    // Pre-select role from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const roleParam = urlParams.get('role');
    if (roleParam) {
      const roleSelect = document.getElementById('role');
      if (roleParam === 'student') {
        roleSelect.value = 'tutee';
      } else if (roleParam === 'tutor') {
        roleSelect.value = 'tutor';
      }
    }

    // Handle registration form submission
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = {
        student_id: document.getElementById('student_id').value.trim(),
        full_name: document.getElementById('full_name').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        role: document.getElementById('role').value,
        course: document.getElementById('course').value,
        year_level: document.getElementById('year_level').value,
        password: document.getElementById('password').value,
        confirm_password: document.getElementById('confirm_password').value,
      };

      const errorMessage = document.getElementById('errorMessage');
      const registerBtn = document.getElementById('registerBtn');

      // Clear previous errors
      errorMessage.style.display = 'none';
      errorMessage.textContent = '';

      // Validate passwords match
      if (formData.password !== formData.confirm_password) {
        errorMessage.textContent = 'Passwords do not match';
        errorMessage.style.display = 'block';
        return;
      }

      // Validate password length
      if (formData.password.length < 6) {
        errorMessage.textContent = 'Password must be at least 6 characters';
        errorMessage.style.display = 'block';
        return;
      }

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(formData.email)) {
        errorMessage.textContent = 'Please enter a valid email address';
        errorMessage.style.display = 'block';
        return;
      }

      // Disable button
      registerBtn.disabled = true;
      registerBtn.textContent = 'Registering...';

      try {
        const response = await api.post('/auth/register', {
          student_id: formData.student_id,
          full_name: formData.full_name,
          email: formData.email,
          phone: formData.phone,
          role: formData.role,
          course: formData.course,
          year_level: formData.year_level,
          password: formData.password,
          status: 'active'
        });

        if (response.success) {
          // Show success message
          const successDiv = document.createElement('div');
          successDiv.className = 'success-message';
          successDiv.textContent = 'Registration successful! Redirecting to login...';
          errorMessage.parentNode.insertBefore(successDiv, errorMessage);
          
          // Redirect to login
          setTimeout(() => {
            window.location.href = `/html/login.html?role=${formData.role === 'tutee' ? 'student' : 'tutor'}`;
          }, 2000);
        }
      } catch (error) {
        console.error('Registration error:', error);
        errorMessage.textContent = error.message || 'Registration failed. Please try again.';
        errorMessage.style.display = 'block';
        registerBtn.disabled = false;
        registerBtn.textContent = 'Register';
      }
    });

    // Real-time password match validation
    document.getElementById('confirm_password').addEventListener('input', function() {
      const password = document.getElementById('password').value;
      const confirmPassword = this.value;
      
      if (confirmPassword && password !== confirmPassword) {
        this.style.borderColor = '#dc3545';
      } else {
        this.style.borderColor = '#ddd';
      }
    });
  </script>
</body>
</html>
