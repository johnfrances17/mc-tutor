<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - MC Tutor</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    .login-hero {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 500px;
      width: 100%;
      overflow: hidden;
    }

    .login-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 25px;
      text-align: center;
      color: white;
    }

    .login-header h1 {
      margin: 0 0 5px 0;
      font-size: 28px;
      font-weight: 700;
    }

    .login-header p {
      margin: 0;
      font-size: 16px;
      opacity: 0.95;
    }

    .login-header .institution {
      margin-top: 5px;
      font-size: 13px;
      opacity: 0.85;
    }

    .login-body {
      padding: 30px;
    }

    .role-selection h2 {
      text-align: center;
      color: #333;
      font-size: 24px;
      margin: 0 0 25px 0;
      font-weight: 600;
    }

    .role-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 25px;
    }

    .role-card {
      background: #f8f9fa;
      border: 3px solid #e0e0e0;
      border-radius: 16px;
      padding: 30px 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .role-card:hover {
      border-color: #667eea;
      background: #f0f3ff;
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
    }

    .role-card .icon {
      font-size: 36px;
      margin-bottom: 12px;
    }

    .role-card h3 {
      color: #333;
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 8px 0;
    }

    .role-card p {
      color: #666;
      font-size: 14px;
      line-height: 1.6;
      margin: 0;
    }

    .login-form {
      display: none;
    }

    .login-form.active {
      display: block;
    }

    .back-btn {
      background: none;
      border: none;
      color: #667eea;
      font-size: 14px;
      cursor: pointer;
      padding: 8px 0;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .back-btn:hover {
      gap: 12px;
      color: #5568d3;
    }

    .form-title {
      text-align: center;
      color: #333;
      font-size: 24px;
      margin: 0 0 20px 0;
      font-weight: 600;
    }

    .auth-footer {
      text-align: center;
      padding-top: 20px;
      border-top: 2px solid #f0f0f0;
      color: #666;
      font-size: 14px;
    }

    .auth-footer a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
    }

    .auth-footer a:hover {
      text-decoration: underline;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .password-toggle {
      position: relative;
    }

    .password-toggle input {
      padding-right: 45px;
    }

    .password-toggle-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #667eea;
      cursor: pointer;
      font-size: 16px;
      padding: 5px;
    }

    .password-toggle-btn:hover {
      color: #5568d3;
    }

    @media (max-width: 768px) {
      .login-body {
        padding: 25px;
      }

      .role-cards {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .login-header h1 {
        font-size: 24px;
      }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .role-cards {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="login-hero">
    <div class="login-container">
      <div class="login-header">
        <h1><i class="fas fa-graduation-cap"></i> MC Tutor</h1>
        <p>Cloud-Based Peer Tutoring Platform</p>
        <p class="institution">Mabini College Inc.</p>
      </div>

      <div class="login-body">
        <!-- Unified Login Form (No Role Selection) -->
        <div id="loginForm" class="login-form active">
          <h2 class="form-title">Login</h2>

          <form id="loginFormElement">
            <div id="errorMessage" class="error-message" style="display: none;"></div>

            <div class="form-group">
              <label for="email"><i class="fas fa-envelope"></i> Email</label>
              <input 
                type="email" 
                id="email" 
                name="email" 
                pattern="[a-zA-Z0-9._%+-]+@mabinicolleges\.edu\.ph$"
                placeholder="Enter your Mabini Colleges email" 
                required
              >
            </div>

            <div class="form-group">
              <label for="password"><i class="fas fa-lock"></i> Password</label>
              <div class="password-toggle">
                <input 
                  type="password" 
                  id="password" 
                  name="password" 
                  placeholder="Enter your account password" 
                  required
                >
                <button type="button" class="password-toggle-btn" onclick="togglePassword('password', this)">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>

            <div style="text-align: right; margin-bottom: 20px;">
              <a href="/html/auth/forgot-password.html" style="color: #667eea; font-size: 14px; text-decoration: none;">
                Forgot password?
              </a>
            </div>

            <button type="submit" class="btn btn-primary" id="loginBtn" style="width: 100%; padding: 15px; font-size: 16px;">
              Login
            </button>
          </form>

          <div class="auth-footer">
            Don't have an account? 
            <a href="/html/auth/register.html">Register here</a>
            <br>
            <a href="/html/auth/admin-login.html" style="font-size: 12px; color: #999; margin-top: 10px; display: inline-block;">Staff Access</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/scripts/utils.js"></script>
  <script src="/scripts/api.js"></script>
  <script src="/scripts/auth.js"></script>
  <script>
    // Clear any stale authentication on login page load
    // This ensures users start fresh when they come to login
    if (window.location.search.includes('logout=true')) {
      localStorage.clear();
      // Remove the logout param from URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    // Toggle password visibility
    function togglePassword(fieldId, button) {
      const input = document.getElementById(fieldId);
      const icon = button.querySelector('i');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    }

    // Check if already logged in
    (function() {
      const user = window.auth?.getCurrentUser();
      if (user) {
        const dashboards = {
          'admin': 'admin-dashboard.html',
          'tutor': 'tutor-dashboard.html',
          'tutee': 'student-dashboard.html'
        };
        window.location.href = dashboards[user.role] || 'student-dashboard.html';
      }
    })();

    // Handle login (unified - no role selection needed)
    document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const errorMessage = document.getElementById('errorMessage');
      const loginBtn = document.getElementById('loginBtn');

      // Validate email domain
      if (!email.endsWith('@mabinicolleges.edu.ph')) {
        errorMessage.textContent = 'Please use your Mabini Colleges email (@mabinicolleges.edu.ph)';
        errorMessage.style.display = 'block';
        return;
      }

      errorMessage.style.display = 'none';
      loginBtn.disabled = true;
      loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';

      try {
        console.log('🔐 Attempting login...', { email });
        
        // No role parameter - backend auto-detects from database
        const response = await window.API.auth.login({
          email: email,
          password: password
          // role is omitted - backend will auto-detect
        });

        console.log('📥 Login response:', response);

        if (response.success && response.data) {
          console.log('✅ Login successful');
          window.auth.saveSession(response.data);
          
          if (window.utils && window.utils.showToast) {
            window.utils.showToast('Login successful!', 'success');
          }
          
          setTimeout(() => {
            // Backend returns user with their actual role
            window.auth.redirectToDashboard(response.data.user.role);
          }, 500);
        } else {
          console.error('❌ Login failed:', response);
          throw new Error(response.error?.message || response.message || 'Login failed');
        }
      } catch (error) {
        console.error('❌ Login error caught:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          error: error
        });
        
        let errorMsg = 'Login failed. Please check your credentials.';
        
        // Better error messages
        if (error.message) {
          if (error.message.includes('fetch') || error.message.includes('network')) {
            errorMsg = 'Network error. Please check your connection and try again.';
          } else if (error.message.includes('Request failed')) {
            errorMsg = 'Server error. Please try again in a moment.';
          } else {
            errorMsg = error.message;
          }
        }
        
        errorMessage.textContent = errorMsg;
        errorMessage.style.display = 'block';
        loginBtn.disabled = false;
        loginBtn.innerHTML = 'Login';
      }
    });
  </script>
</body>
</html>
