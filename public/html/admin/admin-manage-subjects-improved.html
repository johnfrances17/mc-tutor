<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Subjects - MC Tutor Admin</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background: #f5f7fa; min-height: 100vh; }

        /* Navbar */
        .navbar { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .nav-container { max-width: 1400px; margin: 0 auto; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .nav-brand { font-size: 24px; font-weight: 700; background: linear-gradient(135deg, #5865F2, #7289DA); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-decoration: none; }
        .nav-right { display: flex; align-items: center; gap: 20px; }
        .user-info { display: flex; align-items: center; gap: 12px; padding: 8px 16px; background: linear-gradient(135deg, #5865F2, #7289DA); border-radius: 8px; color: white; }
        .user-avatar { width: 35px; height: 35px; border-radius: 50%; background: white; border: 2px solid white; }
        .user-details { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; font-size: 14px; }
        .user-role { font-size: 11px; opacity: 0.9; text-transform: uppercase; }
        .btn-logout { background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: 0.3s; }
        .btn-logout:hover { background: #c82333; transform: translateY(-2px); }

        /* Secondary Nav */
        .secondary-navbar { background: linear-gradient(135deg, #5865F2, #7289DA); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .secondary-nav-container { max-width: 1400px; margin: 0 auto; padding: 15px 20px; display: flex; justify-content: center; gap: 10px; }
        .nav-tab { color: white; text-decoration: none; padding: 10px 20px; border-radius: 8px; font-weight: 500; background: rgba(255,255,255,0.15); transition: 0.3s; }
        .nav-tab:hover { background: white; color: #5865F2; transform: translateY(-2px); }
        .nav-tab.active { background: white; color: #5865F2; }

        /* Main Content */
        .main-container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; }
        .page-header { margin-bottom: 30px; }
        .page-title { font-size: 32px; font-weight: 700; color: #2d3748; margin-bottom: 8px; }
        .page-subtitle { color: #6b7280; font-size: 16px; }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 12px; }
        .stat-value { font-size: 28px; font-weight: 700; color: #2d3748; margin-bottom: 4px; }
        .stat-label { color: #6b7280; font-size: 14px; }

        /* Filters and Actions */
        .controls-bar { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 250px; position: relative; }
        .search-box input { width: 100%; padding: 10px 40px 10px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; }
        .search-box i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #9ca3af; }
        .filter-group { display: flex; gap: 10px; align-items: center; }
        select { padding: 10px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; cursor: pointer; }
        .btn-primary { background: linear-gradient(135deg, #5865F2, #7289DA); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(88,101,242,0.4); }

        /* Subjects Grid */
        .subjects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .subject-card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; transition: 0.3s; }
        .subject-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .subject-header { padding: 20px; background: linear-gradient(135deg, #5865F2, #7289DA); color: white; }
        .subject-code { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .subject-name { font-size: 16px; opacity: 0.95; }
        .subject-body { padding: 20px; }
        .subject-info { margin-bottom: 15px; }
        .info-label { font-size: 12px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .info-value { font-size: 14px; color: #2d3748; font-weight: 500; }
        .course-badge { display: inline-block; padding: 6px 12px; background: #f3f4f6; border-radius: 6px; font-size: 13px; font-weight: 600; color: #5865F2; }
        .description-text { font-size: 14px; color: #6b7280; line-height: 1.6; margin-bottom: 15px; }
        .subject-footer { display: flex; gap: 10px; padding-top: 15px; border-top: 1px solid #e5e7eb; }
        .btn-edit { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; flex: 1; font-weight: 500; transition: 0.3s; }
        .btn-edit:hover { background: #2563eb; }
        .btn-delete { background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; flex: 1; font-weight: 500; transition: 0.3s; }
        .btn-delete:hover { background: #dc2626; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 24px; border-bottom: 2px solid #e5e7eb; }
        .modal-title { font-size: 24px; font-weight: 700; color: #2d3748; }
        .modal-body { padding: 24px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 14px; }
        .form-label .required { color: #ef4444; }
        .form-input { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: 0.3s; }
        .form-input:focus { border-color: #5865F2; outline: none; }
        textarea.form-input { min-height: 100px; resize: vertical; font-family: 'Montserrat', sans-serif; }
        .modal-footer { padding: 20px 24px; border-top: 2px solid #e5e7eb; display: flex; gap: 12px; justify-content: flex-end; }
        .btn-cancel { background: #6b7280; color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: 0.3s; }
        .btn-cancel:hover { background: #4b5563; }
        .btn-save { background: linear-gradient(135deg, #5865F2, #7289DA); color: white; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: 0.3s; }
        .btn-save:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(88,101,242,0.4); }

        /* Alerts */
        .alert { padding: 16px 20px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; font-weight: 500; }
        .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .alert-danger { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .alert-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state i { font-size: 64px; color: #d1d5db; margin-bottom: 16px; }
        .empty-state h3 { font-size: 20px; color: #4b5563; margin-bottom: 8px; }
        .empty-state p { color: #6b7280; }
    </style>
</head>
<body>
    <!-- Top Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/html/admin/admin-dashboard.html" class="nav-brand">MC Tutor Admin</a>
            <div class="nav-right">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user-shield" style="font-size: 20px; color: #5865F2; padding: 7px;"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name" data-user-name>System Administrator</div>
                        <div class="user-role">ADMIN</div>
                    </div>
                </div>
                <button class="btn-logout" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Secondary Navbar -->
    <nav class="secondary-navbar">
        <div class="secondary-nav-container">
            <a href="/html/admin/admin-dashboard.html" class="nav-tab">Dashboard</a>
            <a href="/html/admin/admin-manage-users.html" class="nav-tab">Users</a>
            <a href="/html/admin/admin-manage-sessions.html" class="nav-tab">Sessions</a>
            <a href="/html/admin/admin-manage-subjects.html" class="nav-tab active">Subjects</a>
            <a href="/html/admin/admin-view-materials.html" class="nav-tab">Materials</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Manage Subjects</h1>
            <p class="page-subtitle">View and manage all subjects in the system</p>
        </div>

        <!-- Message Container -->
        <div id="messageContainer"></div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: #dbeafe; color: #3b82f6;">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stat-value" id="totalSubjects">0</div>
                <div class="stat-label">Total Subjects</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #d1fae5; color: #10b981;">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="stat-value" id="totalCourses">6</div>
                <div class="stat-label">Courses</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #fef3c7; color: #f59e0b;">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="stat-value" id="totalTutors">0</div>
                <div class="stat-label">Active Tutors</div>
            </div>
        </div>

        <!-- Controls Bar -->
        <div class="controls-bar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search by code or name...">
                <i class="fas fa-search"></i>
            </div>
            <div class="filter-group">
                <select id="courseFilter">
                    <option value="">All Courses</option>
                    <option value="BSA">BS Accountancy</option>
                    <option value="BSBA">BS Business Administration</option>
                    <option value="BSED">Bachelor in Secondary Education</option>
                    <option value="BSN">BS Nursing</option>
                    <option value="BSCS">BS Computer Science</option>
                    <option value="BSCrim">BS Criminology</option>
                </select>
            </div>
            <button class="btn-primary" onclick="openAddModal()">
                <i class="fas fa-plus"></i> Add Subject
            </button>
        </div>

        <!-- Subjects Grid -->
        <div class="subjects-grid" id="subjectsContainer">
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <h3>Loading subjects...</h3>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal" id="subjectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add New Subject</h2>
            </div>
            <div class="modal-body">
                <form id="subjectForm">
                    <input type="hidden" id="subjectId">
                    
                    <div class="form-group">
                        <label class="form-label">Subject Code <span class="required">*</span></label>
                        <input type="text" class="form-input" id="subjectCode" placeholder="e.g., BSA001" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Subject Name <span class="required">*</span></label>
                        <input type="text" class="form-input" id="subjectName" placeholder="e.g., Financial Accounting" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Course <span class="required">*</span></label>
                        <select class="form-input" id="courseCode" required>
                            <option value="">Select a course</option>
                            <option value="BSA">BS Accountancy</option>
                            <option value="BSBA">BS Business Administration</option>
                            <option value="BSED">Bachelor in Secondary Education</option>
                            <option value="BSN">BS Nursing</option>
                            <option value="BSCS">BS Computer Science</option>
                            <option value="BSCrim">BS Criminology</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" id="description" placeholder="Brief description of the subject..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-save" onclick="saveSubject()">Save Subject</button>
            </div>
        </div>
    </div>

    <script src="/scripts/auth.js"></script>
    <script src="/scripts/api.js"></script>
    <script>
        let allSubjects = [];
        let allCourses = [];
        const coursesMap = {
            'BSA': 'BS Accountancy',
            'BSBA': 'BS Business Administration',
            'BSED': 'Bachelor in Secondary Education',
            'BSN': 'BS Nursing',
            'BSCS': 'BS Computer Science',
            'BSCrim': 'BS Criminology'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            if (!window.auth.requireRole('admin')) return;
            await loadData();
            setupEventListeners();
        });

        async function loadData() {
            try {
                await Promise.all([
                    loadSubjects(),
                    loadCourses()
                ]);
            } catch (error) {
                console.error('Load data error:', error);
            }
        }

        async function loadSubjects() {
            try {
                console.log('Loading subjects...');
                const response = await api.get('/subjects');
                console.log('Subjects response:', response);

                if (!response.success || !response.subjects) {
                    throw new Error(response.message || 'Failed to load subjects');
                }

                allSubjects = response.subjects;
                displaySubjects(allSubjects);
                updateStats();
            } catch (error) {
                console.error('Error loading subjects:', error);
                document.getElementById('subjectsContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error loading subjects</h3>
                        <p>${error.message || 'Please try again later'}</p>
                    </div>
                `;
            }
        }

        async function loadCourses() {
            try {
                const response = await api.get('/courses');
                if (response.success && response.courses) {
                    allCourses = response.courses;
                }
            } catch (error) {
                console.log('Using default courses');
            }
        }

        function displaySubjects(subjects) {
            const container = document.getElementById('subjectsContainer');

            if (subjects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-filter"></i>
                        <h3>No subjects found</h3>
                        <p>Try adjusting your filters or add a new subject</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = subjects.map(subject => `
                <div class="subject-card">
                    <div class="subject-header">
                        <div class="subject-code">${subject.subject_code || 'N/A'}</div>
                        <div class="subject-name">${subject.subject_name || 'Unnamed Subject'}</div>
                    </div>
                    <div class="subject-body">
                        <div class="subject-info">
                            <div class="info-label">Course</div>
                            <div class="info-value">
                                <span class="course-badge">${subject.course_code || 'N/A'}</span>
                                <span style="font-size: 13px; color: #6b7280; margin-left: 8px;">
                                    ${coursesMap[subject.course_code] || subject.course_code || 'N/A'}
                                </span>
                            </div>
                        </div>
                        ${subject.description ? `
                        <div class="subject-info">
                            <div class="info-label">Description</div>
                            <div class="description-text">${subject.description}</div>
                        </div>
                        ` : ''}
                        <div class="subject-info">
                            <div class="info-label">Tutors Teaching This Subject</div>
                            <div class="info-value">${subject.tutor_count || 0} tutors</div>
                        </div>
                        <div class="subject-footer">
                            <button class="btn-edit" onclick="openEditModal(${subject.subject_id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn-delete" onclick="deleteSubject(${subject.subject_id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('totalSubjects').textContent = allSubjects.length;
            
            const courses = new Set(allSubjects.map(s => s.course_code).filter(Boolean));
            document.getElementById('totalCourses').textContent = courses.size || 6;

            const totalTutors = allSubjects.reduce((sum, s) => sum + (s.tutor_count || 0), 0);
            document.getElementById('totalTutors').textContent = totalTutors;
        }

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterSubjects);
            document.getElementById('courseFilter').addEventListener('change', filterSubjects);
        }

        function filterSubjects() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const courseFilter = document.getElementById('courseFilter').value;

            const filtered = allSubjects.filter(subject => {
                const matchesSearch = !searchTerm || 
                    subject.subject_code?.toLowerCase().includes(searchTerm) ||
                    subject.subject_name?.toLowerCase().includes(searchTerm);
                
                const matchesCourse = !courseFilter || subject.course_code === courseFilter;

                return matchesSearch && matchesCourse;
            });

            displaySubjects(filtered);
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Add New Subject';
            document.getElementById('subjectForm').reset();
            document.getElementById('subjectId').value = '';
            document.getElementById('subjectModal').classList.add('active');
        }

        function openEditModal(subjectId) {
            const subject = allSubjects.find(s => s.subject_id === subjectId);
            if (!subject) return;

            document.getElementById('modalTitle').textContent = 'Edit Subject';
            document.getElementById('subjectId').value = subject.subject_id;
            document.getElementById('subjectCode').value = subject.subject_code || '';
            document.getElementById('subjectName').value = subject.subject_name || '';
            document.getElementById('courseCode').value = subject.course_code || '';
            document.getElementById('description').value = subject.description || '';
            document.getElementById('subjectModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('subjectModal').classList.remove('active');
        }

        async function saveSubject() {
            const subjectId = document.getElementById('subjectId').value;
            const subjectCode = document.getElementById('subjectCode').value.trim();
            const subjectName = document.getElementById('subjectName').value.trim();
            const courseCode = document.getElementById('courseCode').value;
            const description = document.getElementById('description').value.trim();

            if (!subjectCode || !subjectName || !courseCode) {
                showMessage('Please fill in all required fields', 'danger');
                return;
            }

            try {
                const data = {
                    subject_code: subjectCode,
                    subject_name: subjectName,
                    course_code: courseCode,
                    description: description || null
                };

                let response;
                if (subjectId) {
                    // Update existing
                    response = await api.put(`/admin/subjects/${subjectId}`, data);
                } else {
                    // Create new
                    response = await api.post('/admin/subjects', data);
                }

                if (response.success) {
                    showMessage(subjectId ? 'Subject updated successfully!' : 'Subject added successfully!', 'success');
                    closeModal();
                    await loadSubjects();
                } else {
                    showMessage(response.message || 'Error saving subject', 'danger');
                }
            } catch (error) {
                console.error('Error saving subject:', error);
                showMessage('Error saving subject. Please try again.', 'danger');
            }
        }

        async function deleteSubject(subjectId) {
            const subject = allSubjects.find(s => s.subject_id === subjectId);
            if (!subject) return;

            if (!confirm(`Are you sure you want to delete "${subject.subject_code} - ${subject.subject_name}"?\n\nThis will also remove it from all tutors teaching this subject.`)) {
                return;
            }

            try {
                const response = await api.delete(`/admin/subjects/${subjectId}`);

                if (response.success) {
                    showMessage('Subject deleted successfully!', 'success');
                    await loadSubjects();
                } else {
                    showMessage(response.message || 'Error deleting subject', 'danger');
                }
            } catch (error) {
                console.error('Error deleting subject:', error);
                showMessage('Error deleting subject. Please try again.', 'danger');
            }
        }

        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            window.auth.handleLogout();
        });

        // Close modal on outside click
        document.getElementById('subjectModal').addEventListener('click', (e) => {
            if (e.target.id === 'subjectModal') closeModal();
        });
    </script>
</body>
</html>
